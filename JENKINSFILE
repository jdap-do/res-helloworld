pipeline {
    agent none

    stages {
        stage('Obtener código') {
            agent { label 'master' }
            steps {
                deleteDir()
                git 'https://github.com/jdap-do/res-helloworld.git'
                bat 'dir'
                stash includes: '**', name: 'workspace'
            }
        }

        stage('Pruebas Unitarias') {
            agent { label 'agent1' }
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    unstash 'workspace'
                    bat 'dir'
                    bat 'set PYTHONPATH=%cd%'
                    bat 'C:/home/agent1/.local/bin/pytest.exe --junitxml=result-unit.xml test/unit'
                    stash includes: 'result-unit.xml', name: 'unit'
                }
            }
        }

        stage('Pruebas de integración (REST)') {
            agent { label 'agent2' }
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    unstash 'workspace'
                    bat 'set FLASK_APP=app/api.py'
                    bat 'start /B C:/home/agent2/.local/bin/flask.exe run'
                    bat 'timeout /t 6'
                    bat 'start /B java -jar C:/home/agent2/wiremock/wiremock-jre8-standalone-2.28.0.jar --port 9090 --root-dir C:/home/agent2/wiremock'
                    bat 'timeout /t 20'
                    bat 'set PYTHONPATH=%cd%'
                    bat 'C:/home/agent2/.local/bin/pytest.exe --junitxml=result-rest.xml test/rest'
                    stash includes: 'result-rest.xml', name: 'rest'
                }
            }
        }

        stage('Análisis estático (flake8)') {
            agent { label 'agent1' }
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    unstash 'workspace'
                    bat 'set PYTHONPATH=%cd%'
                    bat 'C:/home/agent1/.local/bin/flake8 app test --exit-zero 1>flake8.log'
                    recordIssues tools: [flake8(pattern: 'flake8.log')]
                }
            }
        }

        stage('Análisis de seguridad (bandit)') {
            agent { label 'agent1' }
            steps {
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    unstash 'workspace'
                    bat 'set PYTHONPATH=%cd%'
                    bat '''
                        C:/Users/joeda/AppData/Local/Programs/Python/Python313/Scripts/bandit.exe -r app -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}" || exit 0
                    '''
                    recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')], qualityGates: [
                        [threshold: 2, type: 'TOTAL', unstable: true],
                        [threshold: 4, type: 'TOTAL', unstable: false]
                    ]
                }
            }
        }

        stage('Resultados') {
            agent { label 'master' }
            steps {
                unstash 'unit'
                unstash 'rest'
                junit 'result-*.xml'
            }
        }
    }
}